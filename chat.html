<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Chat Alvarez</title>
    <link rel="stylesheet" href="estilos.css">
    <!-- Carga el núcleo de Firebase JS SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <!-- Agrega el manejo de autenticación. -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script src="js/init.js"></script>
  </head>
  <body>
    <h1>Chat Alvarez</h1>
    <form action="javascript:agrega();">
      <input id="texto" type="text" required placeholder="Mensaje">
      <button>Enviar</button>
    </form>
    <button id="cerrarSesion">Cerrar sesión</button>
    <div class="container"> 
      <ol id="mensajes"><li><progress max="100">Cargando…</progress></li></ol>
      <script>
        // @ts-check
        let usuario = "";
        let avatar = "";
        const auth = firebase.auth();
        const cerrarSesionBtn = document.getElementById('cerrarSesion');
        const provider = new firebase.auth.GoogleAuthProvider();
        provider.setCustomParameters({ prompt: "select_account" });

        auth.onAuthStateChanged(
          async usuarioAuth => {
            if (usuarioAuth && usuarioAuth.email) {
              usuario = usuarioAuth.email;
              avatar = usuarioAuth.photoURL;
              muestraMensajes();
            } else {
              await auth.signInWithRedirect(provider);
            }
          },
          procesaError
        );

        const firestore = firebase.firestore();

        function agrega() {
          firestore.collection("MENSAJE").add({
            USUARIO: usuario,
            TEXTO: texto.value.trim(),
            TIMESTAMP: firebase.firestore.FieldValue.serverTimestamp(),
            AVATAR: avatar,
          });
        }

        function muestraMensajes() {
          firestore.collection("MENSAJE").orderBy("TIMESTAMP", "desc")
            .onSnapshot(
              querySnapshot => {
                mensajes.innerHTML = "";
                querySnapshot.forEach(doc => {
                  const data = doc.data();
                  var d = data.TIMESTAMP.toDate(),
                  dformat = [d.getDate(), d.getMonth()+1, d.getFullYear()].join('/')+' '+
                            [d.getHours(),d.getMinutes(),d.getSeconds()].join(':');
                  mensajes.innerHTML += /* html */
                    `<li><img id="Avatar" alt="Avatar" src="${cod(data.AVATAR)}"><div class="msg">${cod(data.TEXTO)}<br><span class="date"><u>${cod(data.USUARIO)}</u><br>${dformat}</span></li></div>`;
                })
              },
              e => {
                procesaError(e);
                muestraMensajes();
              }
            )
        }

        function procesaError(e) {
          console.log(e);
          alert(e.message);
        }

        const codMap = Object.freeze(new Map([['&', '&amp;'], ['<', '&lt;'],
          ['>', '&gt;'], ['"', '&quot;'], ["'", '&#039;']]));

        function cod(texto) {
          return (texto || "").replace(/[&<>"']/g, letra => codMap.get(letra));
        }

        cerrarSesionBtn.addEventListener('click', async () => {
          try {
            await firebase.auth().signOut();
            alert('Sesión cerrada con éxito');
            window.location.href = 'index.html'; // Redirige a index.html
          } catch (error) {
            procesaError(error);
          }
        });
      </script>
    </div>
  </body>
</html>


        
      </script>
      </div>
  </body>
</html>
